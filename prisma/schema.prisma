// Prisma Schema for Presence Manager (Vendor Management System)
// Database: PostgreSQL

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum PermissionLevel {
  denied
  view
  write
  admin
}

enum VendorStatus {
  active
  inactive
}

enum TeamMemberStatus {
  active
  inactive
  onboarding
  offboarded
}

enum ContractStatus {
  draft
  active
  expired
  terminated
}

enum InvoiceStatus {
  pending
  validated
  disputed
  paid
}

enum TimeOffCode {
  VAC // Vacation
  HALF // Half Day
  SICK // Sick Leave
  MAT // Maternity Leave
  CAS // Casual Leave
  UNPAID // Unpaid Leave
}

enum DocumentType {
  CONTRACT            // Main contract document
  SOW                 // Statement of Work
  SLA                 // Service Level Agreement
  NDA                 // Non-Disclosure Agreement
  MSA                 // Master Service Agreement
  AMENDMENT           // Contract amendment
  ADDENDUM            // Contract addendum
  INVOICE             // Invoice document
  PROPOSAL            // Proposal document
  INSURANCE           // Insurance certificate
  COMPLIANCE          // Compliance documentation
  OTHER               // Other document types
}

// ============================================================================
// MODELS
// ============================================================================

/// User model for authentication and authorization
model User {
  id              String          @id @default(cuid())
  email           String          @unique
  password        String          // Hashed password for authentication
  name            String
  permissionLevel PermissionLevel @default(view)
  isActive        Boolean         @default(true)
  isSuperUser     Boolean         @default(false) // Super users have unrestricted access
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relationships
  groups          UserGroup[]     // Groups this user belongs to

  @@index([email])
  @@index([permissionLevel])
  @@index([isActive])
  @@index([isSuperUser])
  @@map("users")
}

// ============================================================================
// ROLE-BASED ACCESS CONTROL (RBAC) MODELS
// ============================================================================

/// PermissionGroup model for grouping users with shared permissions
model PermissionGroup {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?  @db.Text
  isSystem    Boolean  @default(false) // System groups cannot be deleted (e.g., Administrators)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  users               UserGroup[]
  resourcePermissions ResourcePermission[]

  @@index([name])
  @@index([isSystem])
  @@map("permission_groups")
}

/// Junction table for User-PermissionGroup many-to-many relationship
model UserGroup {
  userId    String
  groupId   String
  createdAt DateTime @default(now())

  user  User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  group PermissionGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@id([userId, groupId])
  @@index([userId])
  @@index([groupId])
  @@map("user_groups")
}

/// ProtectableResource model for registering pages and components that can have access control
model ProtectableResource {
  id          String   @id @default(cuid())
  resourceKey String   @unique  // Unique identifier (e.g., "page:dashboard", "component:vendor-documents")
  type        String   @db.VarChar(20) // 'page' or 'component'
  name        String   // Human-readable name
  description String?  @db.Text
  parentKey   String?  // For components, the parent page's resourceKey
  path        String?  // For pages, the route path (e.g., "/dashboard")
  sortOrder   Int      @default(0) // For ordering in the UI
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  permissions ResourcePermission[]

  @@index([resourceKey])
  @@index([type])
  @@index([parentKey])
  @@index([isActive])
  @@map("protectable_resources")
}

/// ResourcePermission model for assigning groups to protectable resources
/// When a resource has no permissions assigned, it's accessible to all authenticated users
/// When permissions are assigned, only users in those groups (+ super users) can access
model ResourcePermission {
  id         String   @id @default(cuid())
  resourceId String
  groupId    String
  createdAt  DateTime @default(now())

  resource ProtectableResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  group    PermissionGroup     @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([resourceId, groupId])
  @@index([resourceId])
  @@index([groupId])
  @@map("resource_permissions")
}

/// Vendor model representing external service providers
model Vendor {
  id                 String       @id @default(cuid())
  name               String
  address            String?
  location           String?
  serviceDescription String?      @db.Text
  status             VendorStatus @default(active)
  // Contract dates (auto-populated from document analysis)
  contractStartDate  DateTime?    @db.Date
  contractEndDate    DateTime?    @db.Date
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  // Relationships
  rateCards   RateCard[]
  teamMembers TeamMember[]
  invoices    Invoice[]
  contracts   Contract[]
  tags        VendorTag[]
  documents   VendorDocument[]

  @@index([name])
  @@index([status])
  @@index([createdAt])
  @@map("vendors")
}

/// VendorDocument model for storing multiple documents per vendor
model VendorDocument {
  id               String       @id @default(cuid())
  vendorId         String
  documentType     DocumentType @default(OTHER)
  title            String?                        // User-friendly document title
  description      String?      @db.Text          // Description of the document
  // File storage fields
  documentKey      String?                        // S3 object key (deprecated - for backward compatibility)
  documentData     Bytes?                         // Binary document data stored in database
  documentName     String                         // Original file name
  documentSize     Int                            // File size in bytes
  documentMimeType String                         // MIME type (e.g., application/pdf)
  storageType      String       @default("database") // 'database' or 's3' (for migration tracking)
  // AI Extraction fields
  enableAiExtraction Boolean   @default(true)     // Whether AI extraction was enabled
  extractionStatus   String?                      // 'pending', 'processing', 'completed', 'failed'
  extractionError    String?   @db.Text           // Error message if extraction failed
  // Dates
  documentDate     DateTime?    @db.Date          // Document effective date (e.g., contract start)
  expiryDate       DateTime?    @db.Date          // Document expiry date
  uploadedAt       DateTime     @default(now())
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Relationships
  vendor     Vendor               @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  aiAnalysis VendorDocumentAnalysis?

  @@index([vendorId])
  @@index([documentType])
  @@index([expiryDate])
  @@index([uploadedAt])
  @@index([storageType])
  @@map("vendor_documents")
}

/// VendorDocumentAnalysis model for AI-extracted document data
model VendorDocumentAnalysis {
  id                   String   @id @default(cuid())
  documentId           String   @unique
  // Core extracted fields
  contractCreationDate String?
  expiryRenewalDate    String?
  involvedEntities     String?  @db.Text          // JSON array of company names
  // SLA fields
  slaDetails           String?  @db.Text          // Service Level Agreements
  uptimeGuarantee      String?
  responseTime         String?
  // Scope and terms
  scopeOfWork          String?  @db.Text
  termsAndConditions   String?  @db.Text
  terminationClauses   String?  @db.Text
  // Commercial terms
  commercialTerms      String?  @db.Text          // Pricing, payment terms, etc.
  paymentSchedule      String?
  totalValue           String?
  currency             String?
  // Additional fields
  noticePeriod         String?
  renewalTerms         String?  @db.Text
  keyContacts          String?  @db.Text          // JSON array
  summary              String?  @db.Text
  // Metadata
  confidenceScores     Json     @default("{}")    // Per-field confidence
  aiProvider           String?                    // 'openai' or 'anthropic'
  aiModel              String?                    // Model used for extraction
  processingTimeMs     Int?                       // Time taken for AI processing
  analyzedAt           DateTime @default(now())
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relationships
  document VendorDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([analyzedAt])
  @@map("vendor_document_analyses")
}

/// Role model representing job roles/positions
model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  rateCards   RateCard[]
  teamMembers TeamMember[]

  @@index([name])
  @@map("roles")
}

/// RateCard model for vendor pricing by role
model RateCard {
  id            String    @id @default(cuid())
  vendorId      String
  roleId        String
  rate          Decimal   @db.Decimal(12, 2)
  currency      String    @default("GBP") @db.VarChar(3)
  effectiveFrom DateTime
  effectiveTo   DateTime?
  notes         String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relationships
  vendor Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Restrict)

  @@unique([vendorId, roleId, effectiveFrom])
  @@index([vendorId])
  @@index([roleId])
  @@index([effectiveFrom])
  @@index([effectiveTo])
  @@index([currency])
  @@map("rate_cards")
}

/// TeamMember model representing contractor personnel
model TeamMember {
  id                 String           @id @default(cuid())
  firstName          String
  lastName           String
  email              String           @unique
  vendorId           String
  roleId             String
  dailyRate          Decimal          @db.Decimal(12, 2)
  currency           String           @default("GBP") @db.VarChar(3)
  startDate          DateTime
  endDate            DateTime?
  status             TeamMemberStatus @default(active)
  plannedUtilization Decimal?         @db.Decimal(5, 2) // Percentage 0-100
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  // Relationships
  vendor           Vendor           @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  role             Role             @relation(fields: [roleId], references: [id], onDelete: Restrict)
  timesheetEntries TimesheetEntry[]
  tags             TeamMemberTag[]

  @@index([vendorId])
  @@index([roleId])
  @@index([email])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@map("team_members")
}

/// TimesheetEntry model for tracking work hours and time off
model TimesheetEntry {
  id           String       @id @default(cuid())
  teamMemberId String
  date         DateTime     @db.Date
  hours        Decimal?     @db.Decimal(4, 2) // Max 99.99 hours
  timeOffCode  TimeOffCode?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // Relationships
  teamMember TeamMember @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)

  @@unique([teamMemberId, date])
  @@index([teamMemberId])
  @@index([date])
  @@index([timeOffCode])
  @@map("timesheet_entries")
}

/// Invoice model for vendor billing
model Invoice {
  id                 String        @id @default(cuid())
  vendorId           String
  invoiceNumber      String        @unique
  invoiceDate        DateTime      @db.Date
  billingPeriodStart DateTime      @db.Date
  billingPeriodEnd   DateTime      @db.Date
  amount             Decimal       @db.Decimal(14, 2)
  currency           String        @default("GBP") @db.VarChar(3)
  status             InvoiceStatus @default(pending)
  expectedAmount     Decimal?      @db.Decimal(14, 2)
  discrepancy        Decimal?      @db.Decimal(14, 2)
  toleranceThreshold Decimal?      @db.Decimal(5, 2) // Percentage
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  // Relationships
  vendor Vendor       @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  tags   InvoiceTag[]

  @@index([vendorId])
  @@index([invoiceNumber])
  @@index([invoiceDate])
  @@index([status])
  @@index([billingPeriodStart])
  @@index([billingPeriodEnd])
  @@map("invoices")
}

/// Contract model for vendor agreements
model Contract {
  id          String         @id @default(cuid())
  vendorId    String
  title       String
  startDate   DateTime       @db.Date
  endDate     DateTime       @db.Date
  value       Decimal        @db.Decimal(14, 2)
  currency    String         @default("GBP") @db.VarChar(3)
  status      ContractStatus @default(draft)
  documentUrl String?
  // Document storage fields for S3-compatible storage (deprecated - for backward compatibility)
  documentKey       String?            // S3 object key (deprecated)
  documentData      Bytes?             // Binary document data stored in database
  documentName      String?            // Original file name
  documentSize      Int?               // File size in bytes
  documentType      String?            // MIME type (e.g., application/pdf)
  documentUploadedAt DateTime?         // When the document was uploaded
  storageType       String?            // 'database' or 's3' (for migration tracking)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relationships
  vendor     Vendor            @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  aiAnalysis ContractAnalysis?
  tags       ContractTag[]

  @@index([vendorId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@index([title])
  @@map("contracts")
}

/// ContractAnalysis model for AI-extracted contract data
model ContractAnalysis {
  id                 String   @id @default(cuid())
  contractId         String   @unique
  expirationDate     String?
  renewalTerms       String?  @db.Text
  sla                String?  @db.Text
  paymentTerms       String?  @db.Text
  noticePeriod       String?
  keyContacts        String?  @db.Text
  scopeSummary       String?  @db.Text
  terminationClauses String?  @db.Text
  confidenceScores   Json     @default("{}")
  analyzedAt         DateTime @default(now())
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relationships
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([analyzedAt])
  @@map("contract_analyses")
}

/// Tag model for categorization
model Tag {
  id        String   @id @default(cuid())
  name      String   @unique
  color     String?  @db.VarChar(7) // Hex color code
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships (many-to-many via junction tables)
  vendors     VendorTag[]
  teamMembers TeamMemberTag[]
  invoices    InvoiceTag[]
  contracts   ContractTag[]

  @@index([name])
  @@map("tags")
}

/// ExchangeRate model for currency conversion
model ExchangeRate {
  id           String   @id @default(cuid())
  fromCurrency String   @db.VarChar(3)
  toCurrency   String   @db.VarChar(3)
  rate         Decimal  @db.Decimal(12, 6)
  lastUpdated  DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([fromCurrency, toCurrency])
  @@index([fromCurrency])
  @@index([toCurrency])
  @@index([lastUpdated])
  @@map("exchange_rates")
}

/// SystemSettings model for application-wide configuration
/// Stores key-value pairs for various settings categories
model SystemSettings {
  id          String   @id @default(cuid())
  category    String   @db.VarChar(50)  // e.g., "currency", "dashboard", "integrations"
  key         String   @db.VarChar(100)
  value       String   @db.Text         // JSON string for complex values
  description String?  @db.Text
  updatedBy   String?                   // User ID who last updated
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([category, key])
  @@index([category])
  @@index([key])
  @@map("system_settings")
}

/// AIApiConfig model for storing encrypted API keys for AI services
model AIApiConfig {
  id              String   @id @default(cuid())
  provider        String   @unique @db.VarChar(50)  // 'anthropic' or 'openai'
  encryptedApiKey String   @db.Text                  // Encrypted API key
  isEnabled       Boolean  @default(true)
  defaultModel    String?  @db.VarChar(100)          // Default model for this provider
  usageCount      Int      @default(0)               // Number of API calls made
  lastUsedAt      DateTime?
  lastTestedAt    DateTime?                          // When connection was last tested
  lastTestStatus  String?  @db.VarChar(20)           // 'success', 'error', 'timeout'
  lastTestMessage String?  @db.Text                  // Last test result message
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([provider])
  @@index([isEnabled])
  @@map("ai_api_configs")
}

/// AIDefaultProvider model for storing the user's preferred default AI provider
model AIDefaultProvider {
  id        String   @id @default(cuid())
  provider  String   @db.VarChar(50)  // 'anthropic' or 'openai'
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ai_default_provider")
}

/// AIUsageLog model for tracking API usage and costs
model AIUsageLog {
  id             String   @id @default(cuid())
  provider       String   @db.VarChar(50)           // 'anthropic' or 'openai'
  model          String   @db.VarChar(100)          // Model used
  operation      String   @db.VarChar(100)          // 'document_analysis', etc.
  inputTokens    Int?                               // Tokens in request
  outputTokens   Int?                               // Tokens in response
  totalTokens    Int?                               // Total tokens
  estimatedCost  Decimal? @db.Decimal(10, 6)        // Estimated cost in USD
  processingTime Int?                               // Processing time in ms
  status         String   @default("success")       // 'success', 'failed', 'rate_limited'
  errorMessage   String?  @db.Text
  // Reference to what was analyzed
  documentId     String?                            // VendorDocument ID if applicable
  contractId     String?                            // Contract ID if applicable
  createdAt      DateTime @default(now())

  @@index([provider])
  @@index([operation])
  @@index([createdAt])
  @@index([status])
  @@map("ai_usage_logs")
}

// ============================================================================
// JUNCTION TABLES (Many-to-Many Relationships)
// ============================================================================

/// Junction table for Vendor-Tag relationship
model VendorTag {
  vendorId  String
  tagId     String
  createdAt DateTime @default(now())

  vendor Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([vendorId, tagId])
  @@index([vendorId])
  @@index([tagId])
  @@map("vendor_tags")
}

/// Junction table for TeamMember-Tag relationship
model TeamMemberTag {
  teamMemberId String
  tagId        String
  createdAt    DateTime @default(now())

  teamMember TeamMember @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)
  tag        Tag        @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([teamMemberId, tagId])
  @@index([teamMemberId])
  @@index([tagId])
  @@map("team_member_tags")
}

/// Junction table for Invoice-Tag relationship
model InvoiceTag {
  invoiceId String
  tagId     String
  createdAt DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([invoiceId, tagId])
  @@index([invoiceId])
  @@index([tagId])
  @@map("invoice_tags")
}

/// Junction table for Contract-Tag relationship
model ContractTag {
  contractId String
  tagId      String
  createdAt  DateTime @default(now())

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  tag      Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([contractId, tagId])
  @@index([contractId])
  @@index([tagId])
  @@map("contract_tags")
}
